name: Backup Supabase to Backblaze B2

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
      
      - name: Backup database roles
        run: |
          /usr/lib/postgresql/17/bin/pg_dumpall --roles-only --dbname "${{ secrets.SUPABASE_DB_URL }}" -f roles.sql
            
      - name: Backup database schema
        run: |
          /usr/lib/postgresql/17/bin/pg_dump --schema-only --dbname "${{ secrets.SUPABASE_DB_URL }}" -f schema.sql
            
      - name: Backup database data
        run: |
          /usr/lib/postgresql/17/bin/pg_dump --data-only --column-inserts --dbname "${{ secrets.SUPABASE_DB_URL }}" -f data.sql
            
      - name: Create compressed archive
        run: |
          tar -czvf backup-$(date +%Y%m%d-%H%M%S).tar.gz roles.sql schema.sql data.sql
          rm -f roles.sql schema.sql data.sql
      
      - name: Setup rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          
      - name: Configure rclone for Backblaze B2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [b2]
          type = b2
          account = ${{ secrets.B2_ACCESS_KEY_ID }}
          key = ${{ secrets.B2_SECRET_ACCESS_KEY }}
          EOF
          
      - name: Upload to Backblaze B2
        run: |
          FILENAME=$(ls backup-*.tar.gz)
          rclone copy "$FILENAME" b2:${{ secrets.B2_BUCKET_NAME }} -v
          
      - name: Cleanup old backups (keep last 30 days)
        run: |
          rclone delete b2:${{ secrets.B2_BUCKET_NAME }} --min-age 30d
          
      - name: Backup completed
        run: echo "Backup completed successfully at $(date)"

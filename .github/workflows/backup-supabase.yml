name: Backup Supabase to Google Drive

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
      
      - name: Backup database roles
        run: |
          /usr/lib/postgresql/17/bin/pg_dumpall --roles-only --dbname "${{ secrets.SUPABASE_DB_URL }}" -f roles.sql
            
      - name: Backup database schema
        run: |
          /usr/lib/postgresql/17/bin/pg_dump --schema-only --dbname "${{ secrets.SUPABASE_DB_URL }}" -f schema.sql
            
      - name: Backup database data
        run: |
          /usr/lib/postgresql/17/bin/pg_dump --data-only --column-inserts --dbname "${{ secrets.SUPABASE_DB_URL }}" -f data.sql
            
      - name: Create compressed archive
        run: |
          tar -czvf backup-$(date +%Y%m%d-%H%M%S).tar.gz roles.sql schema.sql data.sql
          rm -f roles.sql schema.sql data.sql
          
      - name: Upload to Google Drive
        uses: samuelint/google-drive-upload@v1.2.0
        with:
          folder_id: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          service_account: ${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT }}
          source_path: backup-*.tar.gz
          
      - name: Backup completed
        run: echo "Backup completed successfully at $(date)"

name: Backup Supabase to Google Drive

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
      
      - name: Backup database roles
        run: |
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f roles.sql --role-only
            
      - name: Backup database schema
        run: |
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f schema.sql
            
      - name: Backup database data
        run: |
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f data.sql --use-copy --data-only
            
      - name: Create compressed archive
        run: |
          tar -czvf backup-$(date +%Y%m%d-%H%M%S).tar.gz roles.sql schema.sql data.sql
          rm -f roles.sql schema.sql data.sql
          
      - name: Upload to Google Drive
        uses: samuelint/google-drive-upload@v1.2.0
        with:
          folder_id: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          service_account: ${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT }}
          source_path: backup-*.tar.gz
          
      - name: Backup completed
        run: echo "Backup completed successfully at $(date)"
